<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="ProjectInfo">
	<typeAlias alias="ProjectInfo" type="com.neusoft.model.udmgr.dao.pojo.ProjectInfo" />
	<insert id="insert" parameterClass="ProjectInfo">
		INSERT INTO PROJECT_INFO
			(PROJECT_ID,PROJECT_NO,PROJECT_NAME,PROJECT_STATS,
			DEPT_ID,NEED_REPORT,PROJECT_DES,FILL_DATE,WEEK_BEGIN,
			WORK_DAYS,PROJECT_AGENT,PROJECT_OPER,HOURS_RULE)
		VALUES
			(#projectId#,#projectNo#,#projectName#,#projectStats#,
			#deptId#,#needReport#,#projectDes:VARCHAR#,CURRENT_DATE(),#weekBegin#,
			#workDays#,#proAgent:VARCHAR#,#proOper:VARCHAR#,#hoursRule#)
	</insert>
	<update id="updateById" parameterClass="ProjectInfo">
		UPDATE 
			PROJECT_INFO 
		SET
			PROJECT_NO = #projectNo#,PROJECT_NAME = #projectName#,
			PROJECT_STATS = #projectStats#,DEPT_ID=#deptId#,
			NEED_REPORT=#needReport#,PROJECT_DES=#projectDes:VARCHAR#,
			WORK_DAYS = #workDays#,PROJECT_AGENT = #proAgent:VARCHAR#,
			PROJECT_OPER = #proOper:VARCHAR#,WEEK_BEGIN = #weekBegin#,
			HOURS_RULE = #hoursRule#
		WHERE 
			PROJECT_ID = #projectId#
	</update>
	<select id="findById" parameterClass="string" resultClass="ProjectInfo">
		SELECT 
			PROJECT_ID as projectId,PROJECT_NO as projectNo,
			PROJECT_NAME as projectName,PROJECT_STATS as projectStats,
			DEPT_ID as deptId,PROJECT_DES as projectDes,
			NEED_REPORT as needReport,WEEK_BEGIN as weekBegin,
			WORK_DAYS as workDays,PROJECT_AGENT as proAgent,
			PROJECT_OPER as proOper,HOURS_RULE as hoursRule
		FROM
			PROJECT_INFO
		WHERE
			PROJECT_ID = #projectId#
	</select>
	<select id="query_paged_project_count" resultClass="int" parameterClass="map">
		SELECT 
			COUNT(p.PROJECT_ID)
		FROM
			PROJECT_INFO p
		WHERE
		<dynamic>
			<iterate open=" p.DEPT_ID IN (" close=") " conjunction="," property="access_data_set">
				#access_data_set[]#
			</iterate>
			<isNotEmpty property="projectName" prepend=" AND ">
				p.PROJECT_NAME LIKE #projectName#
			</isNotEmpty>
		</dynamic>
	</select>
	<select id="query_hoursRule_ById" resultClass="int" parameterClass="string">
		SELECT
			t.HOURS_RULE 
		FROM
			PROJECT_INFO t
		WHERE
			t.PROJECT_ID = #value#
	</select>
	<select id="query_paged_project" resultClass="ProjectInfo" parameterClass="map">
		SELECT 
			p.PROJECT_ID as projectId,p.PROJECT_NO as projectNo,
			p.PROJECT_NAME as projectName,p.PROJECT_STATS as projectStats,
			p.DEPT_ID as deptId,p.PROJECT_DES as projectDes,
			p.NEED_REPORT as needReport,p.WEEK_BEGIN as weekBegin,
			p.WORK_DAYS as workDays,p.PROJECT_AGENT as proAgent,
			p.PROJECT_OPER as proOper,
			p.HOURS_RULE as hoursRule,
			(
				SELECT 
					SUM(er.WORK_HOURS) 
				FROM 
					EDAILY_REPORT er 
			 	WHERE 
			 		er.PROJECT_ID = p.PROJECT_ID AND 
			 		er.WORK_TYPE IN ('0d0cc048adf440edb55d8e53d756439c','dba8abe0a65945a49ebfc587c947d920')
			 ) as happenDays,
			 (
			 	SELECT 
			 		ub.USER_NAME 
			 	FROM
			 		PRO_TRANSFER_LOGS pt 
			 		LEFT JOIN USER_BASIC ub ON pt.USER_ID = ub.USER_ID
			 	WHERE
			 		pt.PROJECT_ID = p.PROJECT_ID AND
			 		pt.CURRT_STATS = 1 AND
			 		pt.ROLE_TYPE = 'c401a1050fe64b29ba60997e2a576d52'
			 ) as psmName
		FROM
			PROJECT_INFO p
		WHERE
		<dynamic>
			<iterate open=" p.DEPT_ID IN (" close=") " conjunction="," property="access_data_set">
				#access_data_set[]#
			</iterate>
			<isNotEmpty property="projectName" prepend=" AND ">
				p.PROJECT_NAME LIKE #projectName#
			</isNotEmpty>
		</dynamic>
		LIMIT
			#start#,#limit#
	</select>
	<!-- dateSet or PM-TM access project list -->
	<select id="query_legal_projects" resultClass="ComboxModel" parameterClass="map">
		SELECT 
			p.PROJECT_ID as regValue,
			p.PROJECT_NAME as displayValue,
			'dataSet_prolist' as storName,
			p.WEEK_BEGIN as leafNode
		FROM
			PROJECT_INFO p
		WHERE
		<dynamic>
			<iterate property="access_data_set" open="p.DEPT_ID IN (" conjunction="," close=")">
				#access_data_set[]#
			</iterate>
			OR
			p.PROJECT_ID IN 
				(
					SELECT 
						DISTINCT(lg.PROJECT_ID) 
					FROM 
						PRO_TRANSFER_LOGS lg
					WHERE
						lg.CURRT_STATS = 1 AND 
						lg.USER_ID = #KEY_USERID# AND 
						lg.ROLE_TYPE IN ('9e635bb0864f4833aa06f0f1336cad34','c401a1050fe64b29ba60997e2a576d52') 
				)
		</dynamic>
		ORDER BY p.FILL_DATE DESC
	</select>
	<!-- dateSet or PM-TM-EM access project list -->
	<select id="query_all_legal_projects" resultClass="ComboxModel" parameterClass="map">
		SELECT 
			p.PROJECT_ID as regValue,
			p.PROJECT_NAME as displayValue,
			'dataSet_prolist' as storName,
			p.WEEK_BEGIN as leafNode
		FROM
			PROJECT_INFO p
		WHERE
		<dynamic>
			<iterate property="access_data_set" open="p.DEPT_ID IN (" conjunction="," close=")">
				#access_data_set[]#
			</iterate>
			OR
			p.PROJECT_ID IN 
				(
					SELECT 
						DISTINCT(lg.PROJECT_ID) 
					FROM 
						PRO_TRANSFER_LOGS lg
					WHERE
						lg.CURRT_STATS = 1 AND 
						lg.USER_ID = #KEY_USERID# AND 
						lg.ROLE_TYPE IN ('9e635bb0864f4833aa06f0f1336cad34','c401a1050fe64b29ba60997e2a576d52','517a4e05b5d44b5096e9b3bd04bec654') 
				)
		</dynamic>
		ORDER BY p.FILL_DATE DESC
	</select>
	<select id="ckeck_unequel_project_num" resultClass="int" parameterClass="ProjectInfo">
		SELECT
			COUNT(p.PROJECT_ID)
		FROM
			PROJECT_INFO p
		WHERE
			p.DEPT_ID = #deptId# AND 
			(p.PROJECT_NAME = #projectName# OR p.PROJECT_NO = #projectNo#)
	</select>
</sqlMap>
